---
title: "02_dataset2"
format: html
editor: visual
---

```{r}
set.seed(37)
```

## Load data

```{r}
gene_counts_2 <- readRDS("gene_counts_2.rds")
meta2_clean  <- readRDS("meta2_clean.rds")
isoform_counts_2 <- readRDS("isoform_counts_2.rds")
```

# Dataset2

# Differential Gene Expression

### Load libraries

```{r}
#| message: false 
library(tidyverse)
library(DESeq2) 
library(DEXSeq) 
library(fgsea)  
library(msigdbr)
```

### Create colData

```{r}
colData2 <- meta2_clean 
colData2$treatment <- factor(
  colData2$treatment, 
  levels = c("Vehicle", "NB73")
  ) 
all(rownames(colData2) == colnames(gene_counts_2))
```

## DESeq2

### Create DESeqDS object

```{r}
dds2 <- DESeqDataSetFromMatrix(   
  countData = gene_counts_2,   
  colData = colData2,   
  design = ~ treatment ) 
dds2
```

### PCA

```{r}
plotPCA(rlog(dds2), intgroup=c("treatment"))
```

### Test for DE

```{r}
dds2 <- DESeq(dds2) 
res2 <- results(dds2) 
res2
```

```{r}
des_sig_2 <- rownames(res2)[which(res2$padj < 0.05)]
```

## GSEA (FSC)

```{r}
BP_df = msigdbr(species = "human", category = "C5", subcategory = "BP")
BP_list = split(BP_df$ensembl_gene, BP_df$gs_name)
```

```{r}
des_stats_2 <- res2[,"stat"]
names(des_stats_2) <- sub("\\.\\d+$", "", rownames(res2))
des_stats_2 <- des_stats_2[!is.na(des_stats_2)]
des_stats_2 <- sort(des_stats_2, decreasing = TRUE)
```

```{r}
fgsea_des_2 <- fgseaMultilevel(
  pathways = BP_list,
  stats = des_stats_2,
  minSize = 15,
  maxSize = 500,
  scoreType = "std"
)
```

```{r}
fg_sig_des_2 <- fgsea_des_2 %>%
arrange(padj) %>%
filter(padj < 0.05)
nrow(fg_sig_des_2)
```

```{r}
fg_sig_des_2[1:10]
```

All of these pathways are related to **ribosome biogenesis and RNA metabolism/processing**, including:

-   **rRNA and tRNA metabolism/processing** (`GOBP_RRNA_METABOLIC_PROCESS`, `GOBP_TRNA_METABOLIC_PROCESS`, `GOBP_MATURATION_OF_SSU_RRNA`, `GOBP_TRNA_PROCESSING`)

-   **Ribosomal subunit biogenesis** (`GOBP_RIBOSOMAL_LARGE_SUBUNIT_BIOGENESIS`, `GOBP_RIBOSOMAL_SMALL_SUBUNIT_BIOGENESIS`)

-   **Ribonucleoprotein complex assembly** (`GOBP_RIBONUCLEOPROTEIN_COMPLEX_SUBUNIT_ORGANIZATION`)

-   **ncRNA processing and RNA localization** (`GOBP_NCRNA_PROCESSING`, `GOBP_RNA_LOCALIZATION`)

    The top GSEA hits suggest that the treatment primarily affects **ribosome biogenesis and RNA processing programs**.

### (Opt) leading-edge genes

```{r}

```

### (Opt) non-dir

# Differential Isoform Usage

### Pre-filter

```{r}
n_samples <- ncol(isoform_counts_2)    
min_samples <- 3
isoform_counts_filtered_2 <- isoform_counts_2[
  rowSums(isoform_counts_2 >= 10) >= min_samples,
]

```

### Gene annotation

```{r}
txInfo <- readr::read_rds('/home/projects/22140/exam_data/Homo_sapiens.GRCh38.107.chr_patch_hapl_scaff_tx_info.Rds')
```

```{r}
tx2gene <- data.frame(
  featureID = txInfo$transcript_id,
  groupID   = txInfo$gene_id
)
tx2gene_filtered <- tx2gene[tx2gene$featureID %in% rownames(isoform_counts_filtered_2), ]
```

```{r}
featureID_2 <- rownames(isoform_counts_filtered_2)
groupID_2 <- as.character(tx2gene_filtered$groupID[match(featureID_2, tx2gene_filtered$featureID)])

length(featureID_2)
length(groupID_2)
```

## DEXSeq

### Create object

```{r}
dxdSubset_2 <- DEXSeqDataSet(
  countData = isoform_counts_filtered_2,
  sampleData = meta2_clean,
  design= ~ sample + exon + treatment:exon,
  featureID = featureID_2,
  groupID = groupID_2
)
```

### Test for DIU

```{r}
dxdSubset_2 <- estimateSizeFactors(dxdSubset_2)
```

```{r}
dxdSubset_2 <- estimateDispersions(dxdSubset_2)
```

```{r}
dxdSubset_2 <- testForDEU(
  dxdSubset_2,
  fullModel = ~ sample + exon + treatment:exon
)
```

```{r}
dxdSubset_2 <- estimateExonFoldChanges(dxdSubset_2, fitExpToVar = "treatment")
```

```{r}
dxdResult_2 <- DEXSeqResults(dxdSubset_2)
```

```{r}
alpha <- 0.05
dex_sig_2 <- dxdResult_2[!is.na(dxdResult_2$padj) & dxdResult_2$padj < alpha, ]
nrow(dex_sig_2)
length(unique(dex_sig_2$groupID))
```

### Top 5 genes

```{r}
dex_df_2 <- as.data.frame(dxdResult_2)
dex_df_2 <- dex_df_2[order(dex_df_2$padj), ]
top5_genes <- dex_df_2$groupID[!is.na(dex_df_2$padj)][1:5]
top5_genes
```

\[1\] "ENSG00000008838"

\[2\] "ENSG00000141279"

\[3\] "ENSG00000196876"

\[4\]"ENSG00000198793"

\[5\] "ENSG00000147100"

# Compare to DE

```{r}
dexseqResultGene_2 <-
  dxdResult_2 %>%
  as.data.frame() %>%
  as_tibble() %>%
  filter(
    ! is.na(stat)
    ) %>%
  # Select and rename columns
  dplyr::select(
  gene_id = groupID,
  isoform_id = featureID,
  stat,
  log2FC = log2fold_Vehicle_NB73,
  pvalue,
  padj
  ) %>%
  group_by(gene_id) %>%
  # For each gene, keep only the single isoform with the smallest p-value
  slice_min(
    order_by = pvalue,
    n = 1,
    with_ties = FALSE
    ) %>%
  ungroup() %>%
  # Recalculate FDR across genes using those per-gene minimal p-values.
  mutate(
    padj = p.adjust(pvalue, method = 'fdr')
  )
```

## Gene level

### ORA

```{r}
dex_gene_2 <- dexseqResultGene_2 %>%
  mutate(
    gene_id, 
    dex_padj = padj,
    dex_sig = !is.na(padj) & padj < alpha)
```

```{r}
des_gene_2 <- as.data.frame(res2) %>%
  tibble::rownames_to_column("gene_id") %>%
  dplyr::mutate(
    des_padj = padj,
    des_sig = !is.na(padj) & padj < alpha
  )
```

```{r}
univ_2 <- intersect(
  dex_gene_2$gene_id,
  des_gene_2$gene_id
  )
both_2 <- dex_gene_2 %>%
  filter(gene_id %in% univ_2) %>%
  mutate(gene_id, dex_sig) %>%
  inner_join(des_gene_2 %>%
               filter(gene_id %in% univ_2) %>%
               mutate(gene_id, des_sig), by = "gene_id")
# Contingency table (DEXSeq vs DESeq2 significance)
contig_tab_2 <- table(
  DEXSeq = both_2$dex_sig, 
  DESeq2 = both_2$des_sig)
contig_tab_2
```

### Fisher's test

```{r}
ft_2 <- fisher.test(
  contig_tab_2, 
  alternative = "greater")
ft_2
```

## Gene-set level

```{r}
dex_names_2 <- sub("\\.\\d+$", "", dex_gene_2$gene_id)
dex_vals_2 <- dex_gene_2$stat
stats_dex_2 <- setNames(dex_vals_2, dex_names_2)
stats_dex_2 <- stats_dex_2[!is.na(stats_dex_2)]
stats_dex_2 <- sort(stats_dex_2, decreasing = TRUE)
stats_dex_abs <- abs(stats_dex_2)

```

```{r}
fgsea_dex_2 <- fgseaMultilevel(
  pathways = BP_list, 
  stats = stats_dex_2,
  minSize = 15, 
  maxSize = 500, 
  scoreType = "std"
  )
```

```{r}
sig_des_2 <- fgsea_des_2 %>% 
  filter(padj < alpha) %>% 
  arrange(padj)
sig_dex_2 <- fgsea_dex_2 %>%
  as_tibble() %>%
  filter(padj < 0.05) %>%
  arrange(padj)

```

```{r}
n_sig_des_2 <- nrow(sig_des_2)
n_sig_dex_2 <- nrow(sig_dex_2)
# shared pathways (by name)
shared_2 <- intersect(sig_des_2$pathway, sig_dex_2$pathway)
length(shared_2)
```

### Check

```{r}
library(ggplot2)

genes_in_pathways <- unlist(BP_list)
mapping_rate <- sum(names(stats_dex_2) %in% genes_in_pathways) / length(stats_dex_2)
cat("Mapping rate of genes to pathway gene sets:", mapping_rate, "\n")

fgsea_dex_2_df <- as_tibble(fgsea_dex_2)

ggplot(fgsea_dex_2_df, aes(x = pval)) +
  geom_histogram(bins = 50, fill = "steelblue", color = "black") +
  ggtitle("DEXSeq FGSEA: p-value distribution")

ggplot(fgsea_dex_2_df, aes(x = padj)) +
  geom_histogram(bins = 50, fill = "salmon", color = "black") +
  ggtitle("DEXSeq FGSEA: padj distribution")

```

# Combine p-values

```{r}

des_pvals_2 <- data.frame(
  gene_id = rownames(res2),
  pvalue_deseq2 = res2$pvalue,
  stringsAsFactors = FALSE
)

dex_pvals_2 <- data.frame(
  gene_id = dex_df_2$groupID,
  pvalue_dexseq = dex_df_2$pvalue,
  stringsAsFactors = FALSE
)


joint_pvals_2 <- merge(des_pvals_2, dex_pvals_2, by = "gene_id")

joint_pvals_2 <- joint_pvals_2 %>%
  rowwise() %>%
  mutate(
    joint_pval_fisher =
      if (is.na(pvalue_deseq2) || is.na(pvalue_dexseq)) NA
      else metap::sumlog(c(pvalue_deseq2, pvalue_dexseq))$p
  ) %>%
  ungroup()


```

## Gene level

```{r}
joint_pvals_2 <- joint_pvals_2 %>%
  mutate(
    padj_deseq2 = p.adjust(pvalue_deseq2, method = "BH"),
    padj_dexseq  = p.adjust(pvalue_dexseq,  method = "BH"),
    padj_joint   = p.adjust(joint_pval_fisher, method = "BH"),

    sig_deseq2 = padj_deseq2 < alpha,
    sig_dexseq = padj_dexseq  < alpha,
    sig_joint  = padj_joint   < alpha
  )
```

```{r}
sig_counts_2 <- c(
  DESeq2 = sum(joint_pvals_2$sig_deseq2, na.rm = TRUE),
  DEXSeq = sum(joint_pvals_2$sig_dexseq,  na.rm = TRUE),
  Joint  = sum(joint_pvals_2$sig_joint,   na.rm = TRUE)
)

sig_counts_2
```

```{r}
unique_joint_2 <- joint_pvals_2 %>% 
  filter(sig_joint, !sig_deseq2, !sig_dexseq) %>% 
  nrow()
unique_joint_2
```

## Gene-set level

### Creat stats

```{r}
joint_clean_2 <- joint_pvals_2 %>%
  arrange(pvalue_deseq2) %>%  
  distinct(gene_id, .keep_all = TRUE)

                      

```

```{r}
stats_deseq2_2 <- -log10(joint_clean_2$pvalue_deseq2)
names(stats_deseq2_2) <- joint_clean_2$gene_id
stats_deseq2_2 <- stats_deseq2_2[is.finite(stats_deseq2_2)]

stats_dexseq_2 <- -log10(joint_clean_2$pvalue_dexseq)
names(stats_dexseq_2) <- joint_clean_2$gene_id

stats_joint_2  <- -log10(joint_clean_2$joint_pval_fisher)
names(stats_joint_2) <- joint_clean_2$gene_id
stats_joint_2 <- stats_joint_2[is.finite(stats_joint_2)]
```

```{r}
fg_deseq2_j_2 <- fgseaMultilevel(
  pathways = BP_list,
  stats = sort(stats_deseq2_2, decreasing = TRUE),
  scoreType = "pos"
)

fg_dexseq_j_2 <- fgseaMultilevel(
  pathways = BP_list,
  stats = sort(stats_dexseq_2, decreasing = TRUE),
  scoreType = "pos"
)

fg_joint_j_2 <- fgseaMultilevel(
  pathways = BP_list,
  stats = sort(stats_joint_2, decreasing = TRUE),
  scoreType = "pos"
)

```

```{r}
sig_paths <- function(fgsea_res, alpha = 0.05) {
  fgsea_res %>% 
    filter(padj < alpha) %>% 
    pull(pathway) %>% 
    unique()
}

sig_sets_deseq2_2 <- sig_paths(fg_deseq2_j_2)
sig_sets_dexseq_2 <- sig_paths(fg_dexseq_j_2)
sig_sets_joint_2  <- sig_paths(fg_joint_j_2)

```

```{r}
sig_counts_2 <- c(
  DESeq2 = length(sig_sets_deseq2_2),
  DEXSeq = length(sig_sets_dexseq_2),
  Joint  = length(sig_sets_joint_2)
)

sig_counts_2

```

```{r}
unique_joint_2 <- setdiff(
  sig_sets_joint_2,
  union(sig_sets_deseq2_2, sig_sets_dexseq_2)
)

unique_joint_2

```

### MF

```{r}
MF_df <- msigdbr(species = "human", category = "C5", subcategory = "MF")
MF_list <- split(MF_df$ensembl_gene, MF_df$gs_name)

```

```{r}
fg_deseq2_mf_2 <- fgseaMultilevel(
  pathways = MF_list,
  stats = sort(stats_deseq2_2, decreasing = TRUE),
  scoreType = "pos"
)

fg_dexseq_mf_2 <- fgseaMultilevel(
  pathways = MF_list,
  stats = sort(stats_dexseq_2, decreasing = TRUE),
  scoreType = "pos"
)

fg_joint_mf_2 <- fgseaMultilevel(
  pathways = MF_list,
  stats = sort(stats_joint_2, decreasing = TRUE),
  scoreType = "pos"
)
```

```{r}
sig_sets_deseq2_mf_2 <- sig_paths(fg_deseq2_mf_2)
sig_sets_dexseq_mf_2 <- sig_paths(fg_dexseq_mf_2)
sig_sets_joint_mf_2 <- sig_paths(fg_joint_mf_2)

c(DESeq2 = length(sig_sets_deseq2_mf_2),
  DEXSeq = length(sig_sets_dexseq_mf_2),
  Joint  = length(sig_sets_joint_mf_2))
```
