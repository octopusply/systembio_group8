---
title: "01_dataset1"
format: html
editor: visual
---

# Dataset1

# Differential Gene Expression

### Load libraries

```{r}
#| message: false 
library(DESeq2)  
library(fgsea)  
library(msigdbr)
```

### Create colData

```{r}
colData1 <- meta1_clean 
colData1$treatment <- factor(
  colData1$treatment, 
  levels = c("Vehicle", "E2")
  ) 
all(rownames(colData1) == colnames(gene_counts_1))
```

## DESeq2

### Create DESeqDS object

```{r}
dds1 <- DESeqDataSetFromMatrix(   
  countData = gene_counts_1,   
  colData = colData1,   
  design = ~ treatment ) 
dds1
```

### PCA

```{r}
plotPCA(rlog(dds1), intgroup=c("treatment"))
```

### Test for DE

```{r}
dds1 <- DESeq(dds1) 
res1 <- results(dds1) 
res1
```

```{r}
des_sig_1 <- rownames(res1)[which(res1$padj < 0.05)]
```

## GSEA (FSC)

```{r}
BP_df = msigdbr(species = "human", category = "C5", subcategory = "BP")
BP_list = split(BP_df$ensembl_gene, BP_df$gs_name)
```

```{r}
des_stats_1 <- res1[,"stat"]
names(des_stats_1) <- sub("\\.\\d+$", "", rownames(res1))
des_stats_1 <- des_stats_1[!is.na(des_stats_1)]
des_stats_1 <- sort(des_stats_1, decreasing = TRUE)
```

```{r}
fgsea_des_1 <- fgseaMultilevel(
  pathways = BP_list,
  stats = des_stats_1,
  minSize = 15,
  maxSize = 500,
  scoreType = "std"
)
```

```{r}
fg_sig_des_1 <- fgsea_des_1 %>%
arrange(padj) %>%
filter(padj < 0.05)
nrow(fg_sig_des_1)
```

```{r}
fg_sig_des_1[1:10]
```

All of these pathways are related to **ribosome biogenesis and RNA metabolism/processing**, including:

-   **rRNA and tRNA metabolism/processing** (`GOBP_RRNA_METABOLIC_PROCESS`, `GOBP_TRNA_METABOLIC_PROCESS`, `GOBP_MATURATION_OF_SSU_RRNA`, `GOBP_TRNA_PROCESSING`)

-   **Ribosomal subunit biogenesis** (`GOBP_RIBOSOMAL_LARGE_SUBUNIT_BIOGENESIS`, `GOBP_RIBOSOMAL_SMALL_SUBUNIT_BIOGENESIS`)

-   **Ribonucleoprotein complex assembly** (`GOBP_RIBONUCLEOPROTEIN_COMPLEX_SUBUNIT_ORGANIZATION`)

-   **ncRNA processing and RNA localization** (`GOBP_NCRNA_PROCESSING`, `GOBP_RNA_LOCALIZATION`)

    The top GSEA hits suggest that the treatment primarily affects **ribosome biogenesis and RNA processing programs**.

### (Opt) leading-edge genes

```{r}

```

### (Opt) non-dir

# Differential Isoform Usage

### Load libraries

```{r}
#| message: false 
library(DEXSeq)  
library(tidyverse)
```

### Pre-filter

```{r}
n_samples <- ncol(isoform_counts_1)    
min_samples <- 3
isoform_counts_filtered_1 <- isoform_counts_1[
  rowSums(isoform_counts_1 >= 10) >= min_samples,
]

```

### Gene annotation

```{r}
txInfo <- readr::read_rds('/home/projects/22140/exam_data/Homo_sapiens.GRCh38.107.chr_patch_hapl_scaff_tx_info.Rds')
```

```{r}
tx2gene <- data.frame(
  featureID = txInfo$transcript_id,
  groupID   = txInfo$gene_id
)
tx2gene_filtered <- tx2gene[tx2gene$featureID %in% rownames(isoform_counts_filtered_1), ]
```

```{r}
featureID_1 <- rownames(isoform_counts_filtered_1)
groupID_1 <- as.character(tx2gene_filtered$groupID[match(featureID_1, tx2gene_filtered$featureID)])

length(featureID_1)
length(groupID_1)
```

## DEXSeq

### Create object

```{r}
dxdSubset_1 <- DEXSeqDataSet(
  countData = isoform_counts_filtered_1,
  sampleData = meta1_clean,
  design= ~ sample + exon + treatment:exon,
  featureID = featureID_1,
  groupID = groupID_1
)
```

### Test for DIU

```{r}
dxdSubset_1 <- estimateSizeFactors(dxdSubset_1)
```

```{r}
dxdSubset_1 <- estimateDispersions(dxdSubset_1)
```

```{r}
dxdSubset_1 <- testForDEU(
  dxdSubset_1,
  fullModel = ~ sample + exon + treatment:exon
)
```

```{r}
dxdSubset_1 <- estimateExonFoldChanges(dxdSubset_1, fitExpToVar = "treatment")
```

```{r}
dxdResult_1 <- DEXSeqResults(dxdSubset_1)
```

```{r}
alpha <- 0.05
dex_sig_1 <- dxdResult_1[!is.na(dxdResult_1$padj) & dxdResult_1$padj < alpha, ]
nrow(dex_sig_1)
length(unique(dex_sig_1$groupID))
```

### Top 5 genes

```{r}
dex_df_1 <- as.data.frame(dxdResult_1)
dex_df_1 <- dex_df_1[order(dex_df_1$padj), ]
top5_genes <- dex_df_1$groupID[!is.na(dex_df_1$padj)][1:5]
top5_genes
```

\[1\] "ENSG00000008838"

\[2\] "ENSG00000141279"

\[3\] "ENSG00000196876"

\[4\]"ENSG00000198793"

\[5\] "ENSG00000147100"

# Compare to DE

```{r}
dexseqResultGene_1 <-
  dxdResult_1 %>%
  as.data.frame() %>%
  as_tibble() %>%
  filter(
    ! is.na(stat)
    ) %>%
  # Select and rename columns
  dplyr::select(
  gene_id = groupID,
  isoform_id = featureID,
  stat,
  log2FC = log2fold_Vehicle_E2,
  pvalue,
  padj
  ) %>%
  group_by(gene_id) %>%
  # For each gene, keep only the single isoform with the smallest p-value
  slice_min(
    order_by = pvalue,
    n = 1,
    with_ties = FALSE
    ) %>%
  ungroup() %>%
  # Recalculate FDR across genes using those per-gene minimal p-values.
  mutate(
    padj = p.adjust(pvalue, method = 'fdr')
  )
```

## Gene level

### ORA

```{r}
dex_gene_1 <- dexseqResultGene_1 %>%
  mutate(
    gene_id, 
    dex_padj = padj,
    dex_sig = !is.na(padj) & padj < alpha)
```

```{r}
des_gene_1 <- as.data.frame(res1) %>%
  tibble::rownames_to_column("gene_id") %>%
  dplyr::mutate(
    des_padj = padj,
    des_sig = !is.na(padj) & padj < alpha
  )
```

```{r}
univ_1 <- intersect(
  dex_gene_1$gene_id,
  des_gene_1$gene_id
  )
both_1 <- dex_gene_1 %>%
  filter(gene_id %in% univ_1) %>%
  mutate(gene_id, dex_sig) %>%
  inner_join(des_gene_1 %>%
               filter(gene_id %in% univ_1) %>%
               mutate(gene_id, des_sig), by = "gene_id")
# Contingency table (DEXSeq vs DESeq2 significance)
contig_tab_1 <- table(
  DEXSeq = both_1$dex_sig, 
  DESeq2 = both_1$des_sig)
contig_tab_1
```

### Fisher's test

```{r}
ft_1 <- fisher.test(
  contig_tab_1, 
  alternative = "greater")
ft_1
```

## Gene-set level

```{r}
dex_names_1 <- sub("\\.\\d+$", "", dex_gene_1$gene_id)
dex_vals_1 <- dex_gene_1$stat
stats_dex_1 <- setNames(dex_vals_1, dex_names_1)
stats_dex_1 <- stats_dex_1[!is.na(stats_dex_1)]
stats_dex_1 <- sort(stats_dex_1, decreasing = TRUE)
stats_dex_abs <- abs(stats_dex_1)

```

```{r}
fgsea_dex_1 <- fgseaMultilevel(
  pathways = BP_list, 
  stats = stats_dex_1,
  minSize = 15, 
  maxSize = 500, 
  scoreType = "std"
  )
```

```{r}
sig_des_1 <- fgsea_des_1 %>% 
  filter(padj < alpha) %>% 
  arrange(padj)
sig_dex_1 <- fgsea_dex_1 %>%
  as_tibble() %>%
  filter(padj < 0.05) %>%
  arrange(padj)

```

```{r}
n_sig_des_1 <- nrow(sig_des_1)
n_sig_dex_1 <- nrow(sig_dex_1)
# shared pathways (by name)
shared_1 <- intersect(sig_des_1$pathway, sig_dex_1$pathway)
length(shared_1)
```

### Check

```{r}
library(ggplot2)

genes_in_pathways <- unlist(BP_list)
mapping_rate <- sum(names(stats_dex_1) %in% genes_in_pathways) / length(stats_dex_1)
cat("Mapping rate of genes to pathway gene sets:", mapping_rate, "\n")

fgsea_dex_1_df <- as_tibble(fgsea_dex_1)

ggplot(fgsea_dex_1_df, aes(x = pval)) +
  geom_histogram(bins = 50, fill = "steelblue", color = "black") +
  ggtitle("DEXSeq FGSEA: p-value distribution")

ggplot(fgsea_dex_1_df, aes(x = padj)) +
  geom_histogram(bins = 50, fill = "salmon", color = "black") +
  ggtitle("DEXSeq FGSEA: padj distribution")

```
